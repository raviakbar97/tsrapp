<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teh Solo Racikan - Order Report</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #3a7bd5;
      --secondary: #00d2ff;
      --dark: #2c3e50;
      --light: #f8f9fa;
      --success: #2ecc71;
      --danger: #e74c3c;
      --warning: #f39c12;
      --info: #3498db;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f7fb;
      color: #333;
    }
    
    .dashboard-header {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 20px 0;
      margin-bottom: 30px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .dashboard-title {
      font-weight: 700;
      font-size: 1.75rem;
      margin: 0;
    }
    
    .dashboard-subtitle {
      opacity: 0.85;
      font-weight: 300;
      margin: 0;
    }
    
    .stat-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      transition: transform 0.2s;
      height: 100%;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    
    .stat-title {
      color: #8a8a8a;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 5px;
      color: var(--dark);
    }
    
    .stat-icon {
      float: right;
      font-size: 2.5rem;
      opacity: 0.2;
      color: var(--primary);
    }
    
    .stat-positive {
      color: var(--success);
    }
    
    .stat-negative {
      color: var(--danger);
    }
    
    .table-container {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      margin-bottom: 30px;
    }
    
    .table {
      margin-bottom: 0;
    }
    
    .table-responsive {
      max-height: 60vh;
      overflow-y: auto;
    }
    
    th {
      position: sticky;
      top: 0;
      background-color: white;
      z-index: 1;
      font-weight: 600;
      color: #555;
      border-top: none !important;
    }
    
    .currency {
      text-align: right;
      font-family: 'Consolas', monospace;
    }
    
    .positive {
      color: var(--success);
    }
    
    .negative {
      color: var(--danger);
    }
    
    .action-bar {
      margin-bottom: 20px;
    }
    
    .chart-container {
      position: relative;
      margin: auto;
      height: 300px;
      width: 100%;
    }
    
    .chart-options {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }
    
    .chart-option-group {
      margin-bottom: 10px;
    }
    
    .chart-toggle {
      border: 1px solid var(--primary);
      color: var(--primary);
      background: white;
      padding: 5px 10px;
      margin-right: 5px;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .chart-toggle.active {
      background: var(--primary);
      color: white;
    }
    
    .filters-container {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    
    .filter-title {
      font-weight: 600;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
    }
    
    .filter-title i {
      margin-right: 8px;
      color: var(--primary);
    }
    
    .date-inputs {
      display: flex;
      gap: 10px;
    }
    
    .date-inputs .form-control {
      flex: 1;
    }
    
    .filter-button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 8px 20px;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .filter-button:hover {
      background: var(--dark);
    }
    
    .reset-button {
      background: #f1f1f1;
      color: var(--dark);
      border: none;
      padding: 8px 20px;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .reset-button:hover {
      background: #e1e1e1;
    }
    
    .active-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    
    .filter-pill {
      background: #f1f7fe;
      border: 1px solid #d0e3fa;
      color: var(--primary);
      border-radius: 20px;
      padding: 3px 12px;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
    }
    
    .filter-pill i {
      margin-left: 6px;
      cursor: pointer;
    }
    
    .filter-pill i:hover {
      color: var(--danger);
    }
    
    /* Upload Modal Styles */
    .modal-content {
      border-radius: 10px;
      border: none;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }
    
    .modal-header {
      background-color: #f8fafc;
      border-bottom: 1px solid #eaedf2;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
    }
    
    .modal-title {
      font-weight: 600;
      color: var(--dark);
    }
    
    .modal-footer {
      border-top: 1px solid #eaedf2;
      padding: 1rem;
    }
    
    .form-control:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 0.25rem rgba(58, 123, 213, 0.25);
    }
    
    #upload-file-btn {
      background: var(--primary);
      border: none;
      transition: all 0.2s;
    }
    
    #upload-file-btn:hover {
      background: #2a6dc0;
    }
    
    #upload-file-btn:disabled {
      background: #a0b7d6;
    }
    
    #upload-excel-btn {
      position: relative;
      overflow: hidden;
      transition: all 0.2s;
    }
    
    #upload-excel-btn:hover {
      background: #e6e6e6;
    }
    
    #upload-result ul {
      padding-left: 1.5rem;
    }
    
    /* Drag and drop styles */
    .file-upload-area {
      position: relative;
      border: 2px dashed #cdd6e6;
      border-radius: 8px;
      background-color: #f8fafc;
      min-height: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      transition: all 0.3s;
      overflow: hidden;
    }
    
    .file-upload-area.drag-over {
      background-color: #eef2ff;
      border-color: var(--primary);
    }
    
    .file-upload-area input[type="file"] {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      opacity: 0;
      cursor: pointer;
      z-index: 10;
    }
    
    .drop-zone-prompt {
      text-align: center;
      color: #64748b;
      pointer-events: none;
    }
    
    .drop-zone-prompt i {
      color: var(--primary);
    }
    
    .file-upload-area.has-file .drop-zone-prompt {
      display: none;
    }
    
    .file-preview {
      display: none;
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #f8fafc;
      padding: 20px;
      align-items: center;
      justify-content: center;
      z-index: 5;
    }
    
    .file-preview-content {
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    
    .file-icon {
      color: var(--primary);
      margin-right: 10px;
    }
    
    .file-details {
      text-align: left;
    }
    
    .file-name {
      font-weight: 600;
      max-width: 200px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .file-size {
      font-size: 0.8rem;
      color: #64748b;
    }
    
    .file-upload-area.has-file .file-preview {
      display: flex;
    }
    
    /* Manual entry styles */
    .manual-entry-row {
      transition: background-color 0.2s;
    }
    
    .manual-entry-row:hover {
      background-color: #f8fafc;
    }
    
    .manual-entry-row input,
    .manual-entry-row select {
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      padding: 5px 8px;
      width: 100%;
      font-size: 0.9rem;
    }
    
    .manual-entry-row input:focus,
    .manual-entry-row select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(58, 123, 213, 0.1);
      outline: none;
    }
    
    .entry-action-btn {
      color: #64748b;
      background: none;
      border: none;
      padding: 5px;
      cursor: pointer;
      transition: color 0.2s;
    }
    
    .entry-action-btn:hover {
      color: var(--danger);
    }
    
    .entry-required::after {
      content: " *";
      color: var(--danger);
    }
    
    .product-suggestion-list {
      position: absolute;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      max-height: 150px;
      overflow-y: auto;
      z-index: 1000;
      width: 100%;
    }
    
    .product-suggestion-item {
      padding: 8px 12px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .product-suggestion-item:hover {
      background-color: #f8fafc;
    }
    
    #manual-entries .invalid-input {
      border-color: var(--danger);
      background-color: rgba(231, 76, 60, 0.05);
    }
    
    /* Fix table header for large tables */
    #manualEntryModal .table-responsive {
      max-height: 50vh;
    }
    
    #manualEntryModal thead th {
      position: sticky;
      top: 0;
      background-color: #f8fafc;
      z-index: 10;
    }
    
    /* Button styles */
    #add-row-btn {
      transition: all 0.2s;
    }
    
    #add-row-btn:hover {
      background-color: var(--primary);
      color: white;
    }
    
    /* Platform-specific colors */
    .platform-tokopedia {
      background-color: rgba(46, 204, 113, 0.1) !important;
    }
    
    .platform-tokopedia:hover {
      background-color: rgba(46, 204, 113, 0.2) !important;
    }
    
    .platform-tokopedia select.entry-platform {
      border-color: #2ecc71;
      background-color: rgba(46, 204, 113, 0.1);
    }
    
    .platform-lazada {
      background-color: rgba(52, 152, 219, 0.1) !important;
    }
    
    .platform-lazada:hover {
      background-color: rgba(52, 152, 219, 0.2) !important;
    }
    
    .platform-lazada select.entry-platform {
      border-color: #3498db;
      background-color: rgba(52, 152, 219, 0.1);
    }
    
    .platform-instore {
      background-color: rgba(243, 156, 18, 0.1) !important;
    }
    
    .platform-instore:hover {
      background-color: rgba(243, 156, 18, 0.2) !important;
    }
    
    .platform-instore select.entry-platform {
      border-color: #f39c12;
      background-color: rgba(243, 156, 18, 0.1);
    }
  </style>
</head>
<body>
  <div class="dashboard-header">
    <div class="container-fluid">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h1 class="dashboard-title">Teh Solo Racikan</h1>
          <p class="dashboard-subtitle">Shopee Sales Dashboard</p>
        </div>
        <div class="col-md-4 text-end">
          <button id="upload-excel-btn" class="btn btn-light btn-sm me-2" data-bs-toggle="modal" data-bs-target="#uploadModal">
            <i class="fas fa-file-upload me-1"></i> Upload Excel
          </button>
          <button id="manual-entry-btn" class="btn btn-light btn-sm me-2" data-bs-toggle="modal" data-bs-target="#manualEntryModal">
            <i class="fas fa-keyboard me-1"></i> Manual Entry
          </button>
          <button id="refresh-report" class="btn btn-light btn-sm me-2">
            <i class="fas fa-sync-alt me-1"></i> Refresh Data
          </button>
          <button id="data-manager-btn" class="btn btn-light btn-sm me-2">
            <i class="fas fa-database me-1"></i> Simple Editor
          </button>
          <button id="back-to-home" class="btn btn-outline-light btn-sm">
            <i class="fas fa-home me-1"></i> Home
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="container-fluid">
    <!-- Stats Summary Row -->
    <div class="row mb-4">
      <div class="col-md-3 col-sm-6">
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-shopping-cart"></i></div>
          <div class="stat-title">Total Orders</div>
          <div class="stat-value" id="total-orders">-</div>
          <div class="stat-description">Total processed orders</div>
        </div>
      </div>
      
      <div class="col-md-3 col-sm-6">
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-money-bill-wave"></i></div>
          <div class="stat-title">Total Revenue</div>
          <div class="stat-value" id="total-revenue">-</div>
          <div class="stat-description">Gross sales before fees</div>
        </div>
      </div>
      
      <div class="col-md-3 col-sm-6">
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-donate"></i></div>
          <div class="stat-title">MP Fees</div>
          <div class="stat-value" id="total-mpfee">-</div>
          <div class="stat-description">Total marketplace fees</div>
        </div>
      </div>
      
      <div class="col-md-3 col-sm-6">
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-tags"></i></div>
          <div class="stat-title">Vouchers Used</div>
          <div class="stat-value" id="total-voucher">-</div>
          <div class="stat-description">Total voucher discounts</div>
        </div>
      </div>
    </div>

    <!-- Second Stats Row -->
    <div class="row mb-4">
      <div class="col-md-4">
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-piggy-bank"></i></div>
          <div class="stat-title">Total Earnings</div>
          <div class="stat-value" id="total-earnings">-</div>
          <div class="stat-description">Net earnings after fees & vouchers</div>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-box"></i></div>
          <div class="stat-title">COGS</div>
          <div class="stat-value" id="total-cogs">-</div>
          <div class="stat-description">Cost of goods sold</div>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
          <div class="stat-title">Clean Margin</div>
          <div class="stat-value" id="clean-margin">-</div>
          <div class="stat-description"><span id="margin-percentage" class="stat-positive">-</span> margin percentage</div>
        </div>
      </div>
    </div>

    <!-- Product Analysis Section -->
    <div class="row mb-4">
      <!-- Best Selling Products -->
      <div class="col-md-6">
        <div class="table-container h-100">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0"><i class="fas fa-award text-warning me-2"></i>Best Sellers</h4>
            <span class="badge bg-primary rounded-pill">Top 5</span>
          </div>
          <div class="table-responsive" style="max-height: 300px;">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Product</th>
                  <th class="text-center">Units</th>
                  <th class="text-end">Revenue</th>
                  <th class="text-end">% of Total</th>
                </tr>
              </thead>
              <tbody id="best-sellers">
                <tr><td colspan="4" class="text-center">Loading data...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Product Performance -->
      <div class="col-md-6">
        <div class="table-container h-100">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0"><i class="fas fa-chart-bar text-info me-2"></i>Profit Margin by Product</h4>
            <span class="badge bg-info rounded-pill">Performance</span>
          </div>
          <div class="table-responsive" style="max-height: 300px;">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Product</th>
                  <th class="text-end">Margin</th>
                  <th class="text-end">Margin %</th>
                  <th class="text-center">Rating</th>
                </tr>
              </thead>
              <tbody id="product-performance">
                <tr><td colspan="4" class="text-center">Loading data...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Replace Insights Section with Chart Section -->
    <div class="table-container mb-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0"><i class="fas fa-chart-line text-primary me-2"></i>Performance Analysis</h4>
      </div>
      
      <div class="chart-options">
        <div class="chart-option-group">
          <label class="form-label">Select Data to Display:</label>
          <div>
            <button class="chart-toggle active" data-value="revenue">Revenue</button>
            <button class="chart-toggle" data-value="earnings">Earnings</button>
            <button class="chart-toggle" data-value="margin">Margin</button>
            <button class="chart-toggle" data-value="mpfees">MP Fees</button>
            <button class="chart-toggle" data-value="cogs">COGS</button>
          </div>
        </div>
        
        <div class="chart-option-group">
          <label class="form-label">Group By:</label>
          <select id="chart-grouping" class="form-select form-select-sm">
            <option value="date">Date</option>
            <option value="product">Product</option>
          </select>
        </div>
      </div>
      
      <div class="chart-container">
        <canvas id="performance-chart"></canvas>
      </div>
    </div>

    <!-- Data Table -->
    <!-- Filters Section -->
    <div class="filters-container mb-4">
      <div class="filter-title">
        <i class="fas fa-filter"></i> Filter Data
      </div>
      
      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label">Date Range</label>
          <div class="mb-2">
            <select id="date-filter-type" class="form-select form-select-sm">
              <option value="custom">Custom Date Range</option>
              <option value="monthly">Monthly (26th-25th)</option>
              <option value="yearly">Yearly</option>
              <option value="daily">Daily</option>
            </select>
          </div>
          
          <!-- Custom Date Range (default) -->
          <div id="custom-date-filter" class="date-filter-option">
            <div class="date-inputs">
              <input type="date" id="filter-date-from" class="form-control form-control-sm" placeholder="From">
              <input type="date" id="filter-date-to" class="form-control form-control-sm" placeholder="To">
            </div>
          </div>
          
          <!-- Monthly Filter (26th-25th) -->
          <div id="monthly-date-filter" class="date-filter-option d-none">
            <div class="d-flex align-items-center">
              <label class="me-2">Month:</label>
              <select id="filter-month" class="form-select form-select-sm me-2">
                <option value="1">January (26 Dec - 25 Jan)</option>
                <option value="2">February (26 Jan - 25 Feb)</option>
                <option value="3">March (26 Feb - 25 Mar)</option>
                <option value="4">April (26 Mar - 25 Apr)</option>
                <option value="5">May (26 Apr - 25 May)</option>
                <option value="6">June (26 May - 25 Jun)</option>
                <option value="7">July (26 Jun - 25 Jul)</option>
                <option value="8">August (26 Jul - 25 Aug)</option>
                <option value="9">September (26 Aug - 25 Sep)</option>
                <option value="10">October (26 Sep - 25 Oct)</option>
                <option value="11">November (26 Oct - 25 Nov)</option>
                <option value="12">December (26 Nov - 25 Dec)</option>
              </select>
              <label class="me-2">Year:</label>
              <select id="filter-month-year" class="form-select form-select-sm">
                <!-- Will be populated with years -->
              </select>
            </div>
          </div>
          
          <!-- Yearly Filter -->
          <div id="yearly-date-filter" class="date-filter-option d-none">
            <select id="filter-year" class="form-select form-select-sm">
              <!-- Will be populated with years -->
            </select>
          </div>
          
          <!-- Daily Filter -->
          <div id="daily-date-filter" class="date-filter-option d-none">
            <input type="date" id="filter-specific-date" class="form-control form-control-sm">
          </div>
        </div>
        
        <div class="col-md-3 mb-3">
          <label class="form-label">Order Number</label>
          <input type="text" id="filter-order-number" class="form-control form-control-sm" placeholder="Enter order number">
        </div>
        
        <div class="col-md-3 mb-3">
          <label class="form-label">Product Name</label>
          <select id="filter-product-name" class="form-select form-select-sm">
            <option value="">All Products</option>
            <!-- Will be populated dynamically -->
          </select>
        </div>
      </div>
      
      <div class="row">
        <div class="col-md-3 mb-3">
          <label class="form-label">Variation</label>
          <select id="filter-variation" class="form-select form-select-sm">
            <option value="">All Variations</option>
            <!-- Will be populated dynamically -->
          </select>
        </div>
      </div>
      
      <div class="text-end">
        <button id="apply-filters" class="filter-button">
          <i class="fas fa-check me-1"></i> Apply Filters
        </button>
        <button id="reset-filters" class="reset-button ms-2">
          <i class="fas fa-undo me-1"></i> Reset
        </button>
      </div>
      
      <div class="active-filters" id="active-filters">
        <!-- Active filters will appear here -->
      </div>
    </div>

    <div class="table-container">
      <h4 class="mb-3">Order Details</h4>
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Order Date</th>
              <th>Order Number</th>
              <th>Product Name</th>
              <th>Variation</th>
              <th class="text-center">Qty</th>
              <th class="text-end">Base Price</th>
              <th class="text-end">Total Base</th>
              <th class="text-end">Selling Price</th>
              <th class="text-end">Subtotal</th>
              <th class="text-end">MP Fee</th>
              <th class="text-end">Voucher</th>
              <th class="text-end">Earnings</th>
              <th class="text-end">Margin</th>
            </tr>
          </thead>
          <tbody id="report-data">
            <!-- Data will be inserted here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Upload Modal -->
  <div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="uploadModalLabel">Upload Order Data</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="excel-upload-form" enctype="multipart/form-data">
            <div class="mb-3">
              <label for="excelFile" class="form-label">Select Excel File</label>
              <div class="file-upload-area" id="dropzone">
                <input type="file" class="form-control" id="excelFile" name="excelFile" accept=".xlsx, .xls" required>
                <div class="drop-zone-prompt">
                  <i class="fas fa-cloud-upload-alt fa-2x mb-2"></i>
                  <p>Drag & drop your Excel file here or click to browse</p>
                  <p class="text-muted small">Supported formats: .xlsx, .xls</p>
                </div>
              </div>
              <div class="form-text">Upload your Shopee order data in Excel format.</div>
            </div>
            
            <div class="mb-3">
              <label class="form-label">Data Import Mode</label>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="importMode" id="replaceMode" value="replace" checked>
                <label class="form-check-label" for="replaceMode">
                  <strong>Replace</strong> - Replace all existing data with the new file data
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="importMode" id="appendMode" value="append">
                <label class="form-check-label" for="appendMode">
                  <strong>Append</strong> - Add new data to the existing data (skip duplicates)
                </label>
              </div>
            </div>
            
            <div id="upload-status" class="d-none alert alert-info">
              <div class="d-flex align-items-center">
                <div class="spinner-border spinner-border-sm me-2" role="status">
                  <span class="visually-hidden">Uploading...</span>
                </div>
                <span>Processing your file. Please wait...</span>
              </div>
              <div class="progress mt-2" style="height: 5px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
              </div>
            </div>
            <div id="upload-result" class="d-none alert">
              <!-- Result will be displayed here -->
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="upload-file-btn">Upload</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Manual Entry Modal -->
  <div class="modal fade" id="manualEntryModal" tabindex="-1" aria-labelledby="manualEntryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="manualEntryModalLabel">Manual Order Entry</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="manual-entry-form">
            <div class="alert alert-info mb-3">
              <i class="fas fa-info-circle me-2"></i> Enter order details manually. Fields marked with * are required.
            </div>
            
            <div class="mb-3">
              <label class="form-label">Data Import Mode</label>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="manualImportMode" id="manualReplaceMode" value="replace">
                <label class="form-check-label" for="manualReplaceMode">
                  <strong>Replace</strong> - Replace all existing data
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="manualImportMode" id="manualAppendMode" value="append" checked>
                <label class="form-check-label" for="manualAppendMode">
                  <strong>Append</strong> - Add to existing data (skip duplicates)
                </label>
              </div>
            </div>
            
            <div class="table-responsive">
              <table class="table table-bordered table-sm">
                <thead class="table-light">
                  <tr>
                    <th>Order Date *</th>
                    <th>Order Number *</th>
                    <th>Platform *</th>
                    <th>Product Name *</th>
                    <th>Variation</th>
                    <th>Quantity *</th>
                    <th>Selling Price *</th>
                    <th>MP Fee *</th>
                    <th>Voucher</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody id="manual-entries">
                  <!-- Initial 5 rows of empty form fields -->
                </tbody>
              </table>
            </div>
            
            <div class="text-center mb-3">
              <button type="button" class="btn btn-outline-primary btn-sm" id="add-row-btn">
                <i class="fas fa-plus me-1"></i> Add Row
              </button>
            </div>
            
            <div id="manual-entry-status" class="d-none alert alert-info">
              <div class="d-flex align-items-center">
                <div class="spinner-border spinner-border-sm me-2" role="status">
                  <span class="visually-hidden">Processing...</span>
                </div>
                <span>Processing your entries. Please wait...</span>
              </div>
            </div>
            <div id="manual-entry-result" class="d-none alert">
              <!-- Result will be displayed here -->
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="save-entries-btn">Save Entries</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Load report data initially
      loadReportData();
      
      // Set up refresh button
      document.getElementById('refresh-report').addEventListener('click', function() {
        refreshReport();
      });
      
      // Set up back button
      document.getElementById('back-to-home').addEventListener('click', function() {
        window.location.href = '/';
      });
      
      // Set up data manager button
      document.getElementById('data-manager-btn').addEventListener('click', function() {
        window.location.href = '/simple-editor.html';
      });
      
      // Set up file upload functionality
      document.getElementById('upload-file-btn').addEventListener('click', function() {
        uploadExcelFile();
      });
      
      // Set up manual entry functionality
      document.getElementById('manualEntryModal').addEventListener('show.bs.modal', initManualEntryForm);
      document.getElementById('add-row-btn').addEventListener('click', addManualEntryRow);
      document.getElementById('save-entries-btn').addEventListener('click', saveManualEntries);
      
      // Set up drag and drop functionality
      setupDragAndDrop();
    });
    
    function setupDragAndDrop() {
      const dropzone = document.getElementById('dropzone');
      const fileInput = document.getElementById('excelFile');
      
      // Add preview container to the dropzone
      const filePreview = document.createElement('div');
      filePreview.className = 'file-preview';
      filePreview.innerHTML = `
        <div class="file-preview-content">
          <div class="file-icon"><i class="fas fa-file-excel fa-2x"></i></div>
          <div class="file-details">
            <div class="file-name">No file selected</div>
            <div class="file-size">0 KB</div>
          </div>
        </div>
      `;
      dropzone.appendChild(filePreview);
      
      // Handle file selected via input
      fileInput.addEventListener('change', function() {
        updateFilePreview(this.files[0]);
      });
      
      // Handle drag events
      dropzone.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.stopPropagation();
        this.classList.add('drag-over');
      });
      
      dropzone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        e.stopPropagation();
        this.classList.remove('drag-over');
      });
      
      dropzone.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        this.classList.remove('drag-over');
        
        if (e.dataTransfer.files.length) {
          fileInput.files = e.dataTransfer.files;
          updateFilePreview(e.dataTransfer.files[0]);
          
          // Trigger change event on input
          const event = new Event('change', { bubbles: true });
          fileInput.dispatchEvent(event);
        }
      });
    }
    
    function updateFilePreview(file) {
      if (!file) return;
      
      const dropzone = document.getElementById('dropzone');
      const filePreview = dropzone.querySelector('.file-preview');
      const fileName = filePreview.querySelector('.file-name');
      const fileSize = filePreview.querySelector('.file-size');
      
      // Update file details
      fileName.textContent = file.name;
      fileSize.textContent = formatFileSize(file.size);
      
      // Show preview
      dropzone.classList.add('has-file');
    }
    
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    function uploadExcelFile() {
      const fileInput = document.getElementById('excelFile');
      const uploadStatus = document.getElementById('upload-status');
      const uploadResult = document.getElementById('upload-result');
      const appendMode = document.getElementById('appendMode').checked;
      
      // Reset previous results
      uploadResult.classList.add('d-none');
      
      if (!fileInput.files.length) {
        uploadResult.textContent = 'Please select a file to upload.';
        uploadResult.className = 'alert alert-warning';
        uploadResult.classList.remove('d-none');
        return;
      }
      
      // Create form data
      const formData = new FormData();
      formData.append('excelFile', fileInput.files[0]);
      formData.append('appendData', appendMode ? 'true' : 'false');
      
      // Show loading status
      uploadStatus.innerHTML = `
        <div class="d-flex align-items-center">
          <div class="spinner-border spinner-border-sm me-2" role="status">
            <span class="visually-hidden">Uploading...</span>
          </div>
          <span>${appendMode ? 'Processing and appending data' : 'Processing data'}. Please wait...</span>
        </div>
        <div class="progress mt-2" style="height: 5px;">
          <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
        </div>
      `;
      uploadStatus.classList.remove('d-none');
      
      // Disable the upload button
      document.getElementById('upload-file-btn').disabled = true;
      
      // Make the AJAX request
      fetch('/convert', {
        method: 'POST',
        body: formData
      })
      .then(response => {
        if (!response.ok) {
          return response.json().then(errorData => {
            throw new Error(`Server error: ${errorData.error || response.statusText}`);
          }).catch(e => {
            throw new Error(`HTTP Error: ${response.status} ${response.statusText}`);
          });
        }
        return response.json();
      })
      .then(data => {
        // Hide loading status
        uploadStatus.classList.add('d-none');
        
        if (data.success) {
          // Show success message
          let resultHtml = `
            <div>
              <strong>Success!</strong> ${data.appendMode ? 'File processed and data appended successfully.' : 'File processed successfully.'}
              <ul class="mt-2 mb-0">
                <li>Total rows in file: ${data.totalRows}</li>
          `;
          
          if (data.appendMode) {
            resultHtml += `
                <li>Existing records: ${data.existingRows}</li>
                <li>New records added: ${data.addedRows}</li>
                <li>Duplicate records skipped: ${data.duplicateSkipped}</li>
            `;
          } else {
            resultHtml += `
                <li>Records processed: ${data.filteredRows}</li>
            `;
          }
          
          resultHtml += `
                <li>Canceled orders skipped: ${data.removedRows}</li>
              </ul>
            </div>
          `;
          
          uploadResult.innerHTML = resultHtml;
          uploadResult.className = 'alert alert-success';
          
          // Reload the report data
          setTimeout(() => {
            loadReportData();
          }, 1000);
        } else {
          // Show error message
          uploadResult.textContent = `Error: ${data.error}`;
          uploadResult.className = 'alert alert-danger';
        }
        
        uploadResult.classList.remove('d-none');
      })
      .catch(error => {
        // Hide loading status
        uploadStatus.classList.add('d-none');
        
        // Show error message
        uploadResult.textContent = `Upload failed: ${error.message}`;
        uploadResult.className = 'alert alert-danger';
        uploadResult.classList.remove('d-none');
      })
      .finally(() => {
        // Re-enable the upload button
        document.getElementById('upload-file-btn').disabled = false;
      });
    }
    
    async function refreshReport() {
        try {
            // Show loading spinner and disable refresh button
            const refreshBtn = document.getElementById('refresh-btn');
            const originalBtnText = refreshBtn.innerHTML;
            refreshBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Refreshing...';
            refreshBtn.disabled = true;
            
            showLoadingToast("Refreshing report data...");
            
            // Call the refresh-report endpoint instead of directly loading the file
            const response = await fetch('/refresh-report');
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to refresh report');
            }
            
            const result = await response.json();
            
            // Load the report data after the refresh
            await loadReportData();
            
            showSuccessToast("Report refreshed successfully!");
            
            // Restore button state
            refreshBtn.innerHTML = originalBtnText;
            refreshBtn.disabled = false;
        } catch (error) {
            console.error("Error refreshing report:", error);
            showErrorToast(`Failed to refresh report: ${error.message}`);
            
            // Restore button state on error as well
            const refreshBtn = document.getElementById('refresh-btn');
            refreshBtn.innerHTML = 'Refresh Report';
            refreshBtn.disabled = false;
        }
    }
    
    function showToast(message, type = 'success') {
      alert(message); // Simple alert for now - could be replaced with a nicer toast
    }
    
    function loadReportData() {
      // Fetch report data
      fetch('/report-data.json')
        .then(response => response.json())
        .then(data => {
          displayReport(data);
        })
        .catch(error => {
          console.error('Error loading report data:', error);
          document.getElementById('report-data').innerHTML = 
            `<tr><td colspan="13" class="text-center">Error loading data: ${error.message}</td></tr>`;
        });
    }

    // Declare chart variable at a global scope to update it later
    let performanceChart;
    
    function displayReport(data, isFiltered = false) {
      const tbody = document.getElementById('report-data');
      const totalOrders = document.getElementById('total-orders');
      const totalEarnings = document.getElementById('total-earnings');
      const totalRevenue = document.getElementById('total-revenue');
      const totalMpFee = document.getElementById('total-mpfee');
      const totalVoucher = document.getElementById('total-voucher');
      const totalCogs = document.getElementById('total-cogs');
      const cleanMargin = document.getElementById('clean-margin');
      const marginPercentage = document.getElementById('margin-percentage');
      const bestSellersTable = document.getElementById('best-sellers');
      const productPerformanceTable = document.getElementById('product-performance');
      
      // Store original data for filtering - only on initial load
      if (!window.originalData && !isFiltered) {
        window.originalData = JSON.parse(JSON.stringify(data));
      }
      
      // Set up product and variation filters - only on initial load
      if (!isFiltered) {
        populateFilterDropdowns(window.originalData || data);
      }
      
      // Clear existing data
      tbody.innerHTML = '';
      bestSellersTable.innerHTML = '';
      productPerformanceTable.innerHTML = '';
      
      // Format currency function
      const formatCurrency = (value) => {
        return new Intl.NumberFormat('id-ID', {
          style: 'currency',
          currency: 'IDR',
          maximumFractionDigits: 0,
          minimumFractionDigits: 0
        }).format(value).replace('Rp', 'Rp ');
      };
      
      // Format percentage function
      const formatPercentage = (value) => {
        return new Intl.NumberFormat('id-ID', {
          style: 'percent',
          maximumFractionDigits: 2,
          minimumFractionDigits: 2
        }).format(value / 100);
      };
      
      // Calculate additional metrics
      let totalRevenueSummary = 0;
      let totalMpFeeSummary = 0;
      let totalVoucherSummary = 0;
      let totalCogsSummary = 0;
      let cleanMarginSummary = 0;
      
      // Product analytics data
      const productStats = {};
      
      // Data for time-based chart
      const chartData = {
        dates: {},
        products: {}
      };
      
      // Process each order
      data.orders.forEach(order => {
        // Accumulate totals
        totalRevenueSummary += order.subtotal;
        totalMpFeeSummary += order.mpFee;
        totalVoucherSummary += order.voucher;
        totalCogsSummary += order.totalBasePrice;
        cleanMarginSummary += order.margin;
        
        // Track product statistics
        if (!productStats[order.productName]) {
          productStats[order.productName] = {
            name: order.productName,
            quantity: 0,
            revenue: 0,
            cogs: 0,
            margin: 0,
            marginPercentage: 0
          };
        }
        
        productStats[order.productName].quantity += order.quantity;
        productStats[order.productName].revenue += order.subtotal;
        productStats[order.productName].cogs += order.totalBasePrice;
        productStats[order.productName].margin += order.margin;
        
        // Prepare data for charts
        // Group by date (use date only, not time)
        const orderDate = new Date(order.orderDate);
        const dateKey = orderDate.toLocaleDateString('en-GB');
        
        if (!chartData.dates[dateKey]) {
          chartData.dates[dateKey] = {
            revenue: 0,
            earnings: 0,
            margin: 0,
            mpfees: 0,
            cogs: 0,
            count: 0
          };
        }
        
        chartData.dates[dateKey].revenue += order.subtotal;
        chartData.dates[dateKey].earnings += order.earnings;
        chartData.dates[dateKey].margin += order.margin;
        chartData.dates[dateKey].mpfees += order.mpFee;
        chartData.dates[dateKey].cogs += order.totalBasePrice;
        chartData.dates[dateKey].count += 1;
        
        // Group by product
        if (!chartData.products[order.productName]) {
          chartData.products[order.productName] = {
            revenue: 0,
            earnings: 0,
            margin: 0,
            mpfees: 0,
            cogs: 0,
            count: 0
          };
        }
        
        chartData.products[order.productName].revenue += order.subtotal;
        chartData.products[order.productName].earnings += order.earnings;
        chartData.products[order.productName].margin += order.margin;
        chartData.products[order.productName].mpfees += order.mpFee;
        chartData.products[order.productName].cogs += order.totalBasePrice;
        chartData.products[order.productName].count += 1;
        
        // Create new row for order table
        const row = document.createElement('tr');
        
        row.innerHTML = `
          <td>${new Date(order.orderDate).toLocaleDateString('en-GB')} ${new Date(order.orderDate).toLocaleTimeString('en-GB', {hour: '2-digit', minute:'2-digit'})}</td>
          <td>${order.orderNumber}</td>
          <td>${order.productName}</td>
          <td>${order.variationName}</td>
          <td class="text-center">${order.quantity}</td>
          <td class="currency">${formatCurrency(order.basePrice)}</td>
          <td class="currency">${formatCurrency(order.totalBasePrice)}</td>
          <td class="currency">${formatCurrency(order.sellingPrice)}</td>
          <td class="currency">${formatCurrency(order.subtotal)}</td>
          <td class="currency">${formatCurrency(order.mpFee)}</td>
          <td class="currency">${formatCurrency(order.voucher)}</td>
          <td class="currency">${formatCurrency(order.earnings)}</td>
          <td class="currency ${order.margin >= 0 ? 'positive' : 'negative'}">${formatCurrency(order.margin)}</td>
        `;
        
        tbody.appendChild(row);
      });
      
      // Calculate margin percentage
      const marginPercentVal = totalRevenueSummary > 0 ? (cleanMarginSummary / totalRevenueSummary) * 100 : 0;
      
      // Calculate product margin percentages
      Object.values(productStats).forEach(product => {
        product.marginPercentage = product.revenue > 0 ? (product.margin / product.revenue) * 100 : 0;
      });
      
      // Best sellers (by revenue)
      const bestSellers = Object.values(productStats)
        .sort((a, b) => b.revenue - a.revenue)
        .slice(0, 5);
        
      bestSellers.forEach(product => {
        const row = document.createElement('tr');
        const percentOfTotal = (product.revenue / totalRevenueSummary) * 100;
        
        row.innerHTML = `
          <td>${product.name}</td>
          <td class="text-center">${product.quantity}</td>
          <td class="text-end">${formatCurrency(product.revenue)}</td>
          <td class="text-end">${formatPercentage(percentOfTotal)}</td>
        `;
        
        bestSellersTable.appendChild(row);
      });
      
      // Product performance by margin percentage
      const productPerformance = Object.values(productStats)
        .sort((a, b) => b.marginPercentage - a.marginPercentage);
        
      productPerformance.forEach(product => {
        const row = document.createElement('tr');
        
        // Determine performance rating
        let rating = '';
        if (product.marginPercentage >= 35) {
          rating = '<span class="badge bg-success">Excellent</span>';
        } else if (product.marginPercentage >= 25) {
          rating = '<span class="badge bg-info">Good</span>';
        } else if (product.marginPercentage >= 15) {
          rating = '<span class="badge bg-warning">Average</span>';
        } else {
          rating = '<span class="badge bg-danger">Low</span>';
        }
        
        row.innerHTML = `
          <td>${product.name}</td>
          <td class="text-end">${formatCurrency(product.margin)}</td>
          <td class="text-end">${formatPercentage(product.marginPercentage)}</td>
          <td class="text-center">${rating}</td>
        `;
        
        productPerformanceTable.appendChild(row);
      });
      
      // Initialize or update the chart
      initChart(chartData);
      
      // Set up chart toggle functionality
      document.querySelectorAll('.chart-toggle').forEach(button => {
        button.addEventListener('click', function() {
          document.querySelectorAll('.chart-toggle').forEach(btn => btn.classList.remove('active'));
          this.classList.add('active');
          updateChart(chartData, this.getAttribute('data-value'));
        });
      });
      
      // Set up grouping selector
      document.getElementById('chart-grouping').addEventListener('change', function() {
        updateChart(chartData, document.querySelector('.chart-toggle.active').getAttribute('data-value'), this.value);
      });
      
      // Display summary metrics
      totalOrders.textContent = data.summary.totalOrders;
      totalRevenue.textContent = formatCurrency(totalRevenueSummary);
      totalMpFee.textContent = formatCurrency(totalMpFeeSummary);
      totalVoucher.textContent = formatCurrency(totalVoucherSummary);
      totalEarnings.textContent = formatCurrency(data.summary.totalEarnings);
      totalCogs.textContent = formatCurrency(totalCogsSummary);
      cleanMargin.textContent = formatCurrency(cleanMarginSummary);
      marginPercentage.textContent = formatPercentage(marginPercentVal);
      
      // Set margin percentage color
      if (marginPercentVal > 0) {
        marginPercentage.classList.remove('stat-negative');
        marginPercentage.classList.add('stat-positive');
      } else {
        marginPercentage.classList.remove('stat-positive');
        marginPercentage.classList.add('stat-negative');
      }
      
      // Initialize filter functionality - only on initial load
      if (!isFiltered) {
        setupFilters();
      }
    }
    
    // Initialize chart
    function initChart(chartData) {
      const ctx = document.getElementById('performance-chart').getContext('2d');
      
      // Destroy existing chart if it exists
      if (performanceChart) {
        performanceChart.destroy();
      }
      
      // Create initial chart (with revenue by default)
      updateChart(chartData, 'revenue', 'date');
    }
    
    // Update chart when data selection changes
    function updateChart(chartData, dataType = 'revenue', grouping = 'date') {
      const ctx = document.getElementById('performance-chart').getContext('2d');
      const groupMethod = grouping || document.getElementById('chart-grouping').value;
      
      // Get the correct dataset
      const sourceData = groupMethod === 'date' ? chartData.dates : chartData.products;
      
      // Prepare data for chart
      const labels = Object.keys(sourceData);
      const dataValues = Object.values(sourceData).map(item => item[dataType]);
      
      // Get color based on data type
      let backgroundColor, borderColor;
      switch(dataType) {
        case 'revenue':
          backgroundColor = 'rgba(58, 123, 213, 0.2)';
          borderColor = 'rgba(58, 123, 213, 1)';
          break;
        case 'earnings':
          backgroundColor = 'rgba(46, 204, 113, 0.2)';
          borderColor = 'rgba(46, 204, 113, 1)';
          break;
        case 'margin':
          backgroundColor = 'rgba(52, 152, 219, 0.2)';
          borderColor = 'rgba(52, 152, 219, 1)';
          break;
        case 'mpfees':
          backgroundColor = 'rgba(231, 76, 60, 0.2)';
          borderColor = 'rgba(231, 76, 60, 1)';
          break;
        case 'cogs':
          backgroundColor = 'rgba(243, 156, 18, 0.2)';
          borderColor = 'rgba(243, 156, 18, 1)';
          break;
        default:
          backgroundColor = 'rgba(58, 123, 213, 0.2)';
          borderColor = 'rgba(58, 123, 213, 1)';
      }
      
      // Get formatted label based on data type
      let dataLabel;
      switch(dataType) {
        case 'revenue':
          dataLabel = 'Revenue';
          break;
        case 'earnings':
          dataLabel = 'Earnings';
          break;
        case 'margin':
          dataLabel = 'Margin';
          break;
        case 'mpfees':
          dataLabel = 'Marketplace Fees';
          break;
        case 'cogs':
          dataLabel = 'Cost of Goods Sold';
          break;
        default:
          dataLabel = 'Value';
      }
      
      // Destroy existing chart if it exists
      if (performanceChart) {
        performanceChart.destroy();
      }
      
      // Create new chart
      performanceChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: dataLabel,
            data: dataValues,
            backgroundColor: backgroundColor,
            borderColor: borderColor,
            borderWidth: 2,
            pointBackgroundColor: borderColor,
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  if (context.parsed.y !== null) {
                    label += new Intl.NumberFormat('id-ID', {
                      style: 'currency',
                      currency: 'IDR',
                      minimumFractionDigits: 0
                    }).format(context.parsed.y);
                  }
                  return label;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return new Intl.NumberFormat('id-ID', {
                    style: 'currency',
                    currency: 'IDR',
                    notation: 'compact',
                    compactDisplay: 'short',
                    minimumFractionDigits: 0
                  }).format(value);
                }
              }
            }
          }
        }
      });
    }
    
    // Function to populate product and variation dropdowns
    function populateFilterDropdowns(data) {
      const productSelect = document.getElementById('filter-product-name');
      const variationSelect = document.getElementById('filter-variation');
      
      // Clear existing options except the first one
      while (productSelect.options.length > 1) {
        productSelect.remove(1);
      }
      
      while (variationSelect.options.length > 1) {
        variationSelect.remove(1);
      }
      
      // Get unique products and variations
      const products = new Set();
      const variations = new Set();
      
      data.orders.forEach(order => {
        products.add(order.productName);
        variations.add(order.variationName);
      });
      
      // Add options to dropdowns
      products.forEach(product => {
        const option = document.createElement('option');
        option.value = product;
        option.textContent = product;
        productSelect.appendChild(option);
      });
      
      variations.forEach(variation => {
        const option = document.createElement('option');
        option.value = variation;
        option.textContent = variation;
        variationSelect.appendChild(option);
      });
    }
    
    // Set up filter functionality
    function setupFilters() {
      const applyFiltersBtn = document.getElementById('apply-filters');
      const resetFiltersBtn = document.getElementById('reset-filters');
      const dateFilterType = document.getElementById('date-filter-type');
      
      // Initialize the date filter dropdowns
      initializeDateFilters();
      
      // Toggle date filter type visibility
      dateFilterType.addEventListener('change', function() {
        toggleDateFilterVisibility(this.value);
      });
      
      applyFiltersBtn.addEventListener('click', applyFilters);
      resetFiltersBtn.addEventListener('click', resetFilters);
    }
    
    // Initialize date filters with available years
    function initializeDateFilters() {
      const yearlyFilter = document.getElementById('filter-year');
      const monthlyYearFilter = document.getElementById('filter-month-year');
      
      // Get current year and range for dropdown (5 years back, 1 year ahead)
      const currentYear = new Date().getFullYear();
      const startYear = currentYear - 5;
      const endYear = currentYear + 1;
      
      // Populate year dropdowns
      for (let year = endYear; year >= startYear; year--) {
        // Yearly filter dropdown
        const yearOption = document.createElement('option');
        yearOption.value = year;
        yearOption.textContent = year;
        yearlyFilter.appendChild(yearOption);
        
        // Monthly filter year dropdown
        const monthYearOption = document.createElement('option');
        monthYearOption.value = year;
        monthYearOption.textContent = year;
        monthlyYearFilter.appendChild(monthYearOption);
      }
      
      // Set current year as default
      yearlyFilter.value = currentYear;
      monthlyYearFilter.value = currentYear;
      
      // Set current month as default for monthly filter
      const currentMonth = new Date().getMonth() + 1; // JS months are 0-indexed
      document.getElementById('filter-month').value = currentMonth;
      
      // Set current date as default for daily filter
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('filter-specific-date').value = today;
    }
    
    // Toggle visibility of date filter options based on selected type
    function toggleDateFilterVisibility(filterType) {
      // Hide all filter options first
      document.querySelectorAll('.date-filter-option').forEach(el => {
        el.classList.add('d-none');
      });
      
      // Show the selected filter type
      switch (filterType) {
        case 'custom':
          document.getElementById('custom-date-filter').classList.remove('d-none');
          break;
        case 'monthly':
          document.getElementById('monthly-date-filter').classList.remove('d-none');
          break;
        case 'yearly':
          document.getElementById('yearly-date-filter').classList.remove('d-none');
          break;
        case 'daily':
          document.getElementById('daily-date-filter').classList.remove('d-none');
          break;
      }
    }
    
    // Apply filters to the data
    function applyFilters() {
      if (!window.originalData) {
        return;
      }
      
      // Get filter values based on selected date filter type
      const dateFilterType = document.getElementById('date-filter-type').value;
      let dateFrom, dateTo;
      
      switch (dateFilterType) {
        case 'custom':
          dateFrom = document.getElementById('filter-date-from').value;
          dateTo = document.getElementById('filter-date-to').value;
          break;
        
        case 'monthly':
          // For monthly filter (26th-25th cycle)
          const selectedMonth = parseInt(document.getElementById('filter-month').value);
          const selectedYear = parseInt(document.getElementById('filter-month-year').value);
          
          // Start date: 26th of previous month
          const startMonth = selectedMonth === 1 ? 12 : selectedMonth - 1;
          const startYear = selectedMonth === 1 ? selectedYear - 1 : selectedYear;
          dateFrom = `${startYear}-${startMonth.toString().padStart(2, '0')}-26`;
          
          // End date: 25th of selected month
          dateTo = `${selectedYear}-${selectedMonth.toString().padStart(2, '0')}-25`;
          break;
        
        case 'yearly':
          // For yearly filter (entire year)
          const year = document.getElementById('filter-year').value;
          dateFrom = `${year}-01-01`;
          dateTo = `${year}-12-31`;
          break;
        
        case 'daily':
          // For daily filter (specific day)
          const specificDate = document.getElementById('filter-specific-date').value;
          dateFrom = specificDate;
          dateTo = specificDate;
          break;
      }
      
      const orderNumber = document.getElementById('filter-order-number').value.trim().toLowerCase();
      const productName = document.getElementById('filter-product-name').value;
      const variation = document.getElementById('filter-variation').value;
      
      // Clone original data
      const filteredData = JSON.parse(JSON.stringify(window.originalData));
      
      // Filter orders
      filteredData.orders = filteredData.orders.filter(order => {
        const orderDate = new Date(order.orderDate);
        
        // Date range filter
        if (dateFrom && new Date(dateFrom) > orderDate) {
          return false;
        }
        
        if (dateTo) {
          // Add 1 day to dateTo to include the entire day
          const endDate = new Date(dateTo);
          endDate.setDate(endDate.getDate() + 1);
          if (endDate < orderDate) {
            return false;
          }
        }
        
        // Order number filter
        if (orderNumber && !order.orderNumber.toLowerCase().includes(orderNumber)) {
          return false;
        }
        
        // Product name filter
        if (productName && order.productName !== productName) {
          return false;
        }
        
        // Variation filter
        if (variation && order.variationName !== variation) {
          return false;
        }
        
        return true;
      });
      
      // Display active filters
      displayActiveFilters(dateFilterType);
      
      // Recalculate summary
      recalculateSummary(filteredData);
      
      // Display filtered data
      displayReport(filteredData, true);
    }
    
    // Display active filters as pills
    function displayActiveFilters(dateFilterType) {
      const activeFiltersContainer = document.getElementById('active-filters');
      activeFiltersContainer.innerHTML = '';
      
      // Get values based on the current filter type
      let dateFrom, dateTo, dateLabel;
      
      switch (dateFilterType) {
        case 'custom':
          dateFrom = document.getElementById('filter-date-from').value;
          dateTo = document.getElementById('filter-date-to').value;
          dateLabel = "Custom Date";
          break;
        
        case 'monthly':
          const monthSelect = document.getElementById('filter-month');
          const monthYearSelect = document.getElementById('filter-month-year');
          const monthName = monthSelect.options[monthSelect.selectedIndex].text.split(' ')[0];
          dateLabel = `Month: ${monthName} ${monthYearSelect.value}`;
          break;
        
        case 'yearly':
          const yearSelect = document.getElementById('filter-year');
          dateLabel = `Year: ${yearSelect.value}`;
          break;
        
        case 'daily':
          const specificDate = document.getElementById('filter-specific-date').value;
          if (specificDate) {
            const formattedDate = new Date(specificDate).toLocaleDateString('en-GB');
            dateLabel = `Date: ${formattedDate}`;
          }
          break;
      }
      
      const orderNumber = document.getElementById('filter-order-number').value.trim();
      const productName = document.getElementById('filter-product-name').value;
      const variation = document.getElementById('filter-variation').value;
      
      // Add date filter pill if applicable
      if (dateFilterType === 'custom' && (dateFrom || dateTo)) {
        const pill = document.createElement('div');
        pill.className = 'filter-pill';
        
        if (dateFrom && dateTo) {
          pill.innerHTML = `Date: ${dateFrom} to ${dateTo} <i class="fas fa-times" data-filter="date"></i>`;
        } else if (dateFrom) {
          pill.innerHTML = `Date: From ${dateFrom} <i class="fas fa-times" data-filter="date"></i>`;
        } else {
          pill.innerHTML = `Date: Until ${dateTo} <i class="fas fa-times" data-filter="date"></i>`;
        }
        
        activeFiltersContainer.appendChild(pill);
      } else if (dateFilterType !== 'custom' && dateLabel) {
        // For non-custom date filters
        const pill = document.createElement('div');
        pill.className = 'filter-pill';
        pill.innerHTML = `${dateLabel} <i class="fas fa-times" data-filter="date"></i>`;
        activeFiltersContainer.appendChild(pill);
      }
      
      if (orderNumber) {
        const pill = document.createElement('div');
        pill.className = 'filter-pill';
        pill.innerHTML = `Order: ${orderNumber} <i class="fas fa-times" data-filter="order"></i>`;
        activeFiltersContainer.appendChild(pill);
      }
      
      if (productName) {
        const pill = document.createElement('div');
        pill.className = 'filter-pill';
        pill.innerHTML = `Product: ${productName} <i class="fas fa-times" data-filter="product"></i>`;
        activeFiltersContainer.appendChild(pill);
      }
      
      if (variation) {
        const pill = document.createElement('div');
        pill.className = 'filter-pill';
        pill.innerHTML = `Variation: ${variation} <i class="fas fa-times" data-filter="variation"></i>`;
        activeFiltersContainer.appendChild(pill);
      }
      
      // Add click handlers to remove individual filters
      document.querySelectorAll('.filter-pill i').forEach(icon => {
        icon.addEventListener('click', function() {
          const filterType = this.getAttribute('data-filter');
          
          if (filterType === 'date') {
            // Reset date filters based on the active filter type
            const dateFilterType = document.getElementById('date-filter-type').value;
            
            if (dateFilterType === 'custom') {
              document.getElementById('filter-date-from').value = '';
              document.getElementById('filter-date-to').value = '';
            } else {
              // Switch back to custom date filter (empty)
              document.getElementById('date-filter-type').value = 'custom';
              toggleDateFilterVisibility('custom');
              document.getElementById('filter-date-from').value = '';
              document.getElementById('filter-date-to').value = '';
            }
          } else if (filterType === 'order') {
            document.getElementById('filter-order-number').value = '';
          } else if (filterType === 'product') {
            document.getElementById('filter-product-name').value = '';
          } else if (filterType === 'variation') {
            document.getElementById('filter-variation').value = '';
          }
          
          applyFilters();
        });
      });
    }
    
    // Reset all filters
    function resetFilters() {
      // Reset date filter type to default
      document.getElementById('date-filter-type').value = 'custom';
      toggleDateFilterVisibility('custom');
      
      // Reset all input fields
      document.getElementById('filter-date-from').value = '';
      document.getElementById('filter-date-to').value = '';
      document.getElementById('filter-order-number').value = '';
      document.getElementById('filter-product-name').value = '';
      document.getElementById('filter-variation').value = '';
      
      // Reset daily filter
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('filter-specific-date').value = today;
      
      // Reset monthly filter
      const currentMonth = new Date().getMonth() + 1;
      document.getElementById('filter-month').value = currentMonth;
      
      // Clear active filters
      document.getElementById('active-filters').innerHTML = '';
      
      // Reload original data
      if (window.originalData) {
        displayReport(window.originalData, true);
      }
    }
    
    // Recalculate summary based on filtered data
    function recalculateSummary(filteredData) {
      let totalRevenueSummary = 0;
      let totalMpFeeSummary = 0;
      let totalVoucherSummary = 0;
      let totalCogsSummary = 0;
      let totalEarningsSummary = 0;
      let cleanMarginSummary = 0;
      
      filteredData.orders.forEach(order => {
        totalRevenueSummary += order.subtotal;
        totalMpFeeSummary += order.mpFee;
        totalVoucherSummary += order.voucher;
        totalCogsSummary += order.totalBasePrice;
        totalEarningsSummary += order.earnings;
        cleanMarginSummary += order.margin;
      });
      
      // Update the summary object
      filteredData.summary = {
        totalOrders: filteredData.orders.length,
        totalEarnings: totalEarningsSummary,
        averageMargin: filteredData.orders.length > 0 ? (cleanMarginSummary / totalRevenueSummary) * 100 : 0
      };
    }

    // Initialize manual entry form
    function initManualEntryForm() {
      const tableBody = document.getElementById('manual-entries');
      const entryResult = document.getElementById('manual-entry-result');
      
      // Clear previous entries and results
      tableBody.innerHTML = '';
      entryResult.classList.add('d-none');
      
      // Add initial 5 rows
      for (let i = 0; i < 5; i++) {
        addManualEntryRow();
      }
      
      // Reset form state
      document.getElementById('manual-entry-status').classList.add('d-none');
      document.getElementById('manualAppendMode').checked = true;
    }
    
    // Add a new row to the manual entry form
    function addManualEntryRow() {
      const tableBody = document.getElementById('manual-entries');
      const rowId = 'entry-row-' + (tableBody.children.length + 1);
      
      const row = document.createElement('tr');
      row.id = rowId;
      row.className = 'manual-entry-row';
      
      // Default date to today
      const today = new Date().toISOString().split('T')[0];
      
      row.innerHTML = `
        <td>
          <input type="datetime-local" class="form-control form-control-sm entry-date" required>
        </td>
        <td>
          <input type="text" class="form-control form-control-sm entry-order-number" required placeholder="e.g., 250426A1B2C3D4">
        </td>
        <td>
          <select class="form-control form-control-sm entry-platform" required>
            <option value="">Select Platform</option>
            <option value="tokopedia">Tokopedia</option>
            <option value="lazada">Lazada</option>
            <option value="instore">In-store</option>
          </select>
        </td>
        <td>
          <select class="form-control form-control-sm entry-product-name" required>
            <option value="">Select Product</option>
            <!-- Products will be populated by JavaScript -->
          </select>
        </td>
        <td>
          <select class="form-control form-control-sm entry-variation">
            <option value="">Select Variation</option>
            <!-- Variations will be populated based on selected product -->
          </select>
        </td>
        <td>
          <input type="number" class="form-control form-control-sm entry-quantity" min="1" required>
        </td>
        <td>
          <input type="number" class="form-control form-control-sm entry-price" min="0" step="1000" required placeholder="Selling price (not base price)">
        </td>
        <td>
          <input type="number" class="form-control form-control-sm entry-mpfee" min="0" required>
        </td>
        <td>
          <input type="number" class="form-control form-control-sm entry-voucher" min="0">
        </td>
        <td class="text-center">
          <button type="button" class="entry-action-btn remove-row" data-row-id="${rowId}" title="Remove Row">
            <i class="fas fa-trash-alt"></i>
          </button>
        </td>
      `;
      
      tableBody.appendChild(row);
      
      // Set default date and time (current)
      const dateNow = new Date();
      const timezoneOffset = dateNow.getTimezoneOffset() * 60000;
      const localDateTime = new Date(dateNow - timezoneOffset).toISOString().slice(0, 16);
      row.querySelector('.entry-date').value = localDateTime;
      
      // Add event listener for removing the row
      row.querySelector('.remove-row').addEventListener('click', function() {
        const rowId = this.getAttribute('data-row-id');
        document.getElementById(rowId).remove();
      });
      
      // Add event listener for platform change to update row color
      row.querySelector('.entry-platform').addEventListener('change', function() {
        updateRowColorByPlatform(row, this.value);
      });
      
      // Populate product dropdown options
      populateProductDropdown(row.querySelector('.entry-product-name'));
      
      // Add event listener for product selection to update variations
      row.querySelector('.entry-product-name').addEventListener('change', function() {
        const productName = this.value;
        populateVariationDropdown(row.querySelector('.entry-variation'), productName);
        updateBasePrice(row);
      });
      
      // Add event listener for variation selection to update unit price
      row.querySelector('.entry-variation').addEventListener('change', function() {
        updateBasePrice(row);
      });
      
      // Add event listener for quantity change
      row.querySelector('.entry-quantity').addEventListener('change', function() {
        updateMpFee(row);
      });
      
      // Add event listener for price change
      row.querySelector('.entry-price').addEventListener('change', function() {
        updateMpFee(row);
      });
    }
    
    // Product catalog cache
    let productCatalog = null;
    
    // Load product catalog data
    async function loadProductCatalog() {
      if (productCatalog === null) {
        try {
          const response = await fetch('/products-catalog.json');
          if (!response.ok) {
            throw new Error(`Failed to load product catalog: ${response.status} ${response.statusText}`);
          }
          productCatalog = await response.json();
          console.log(`Loaded ${productCatalog.products.length} products from catalog`);
        } catch (error) {
          console.error('Error loading product catalog:', error);
          showManualEntryResult('Failed to load product catalog. Please refresh and try again.', 'danger');
        }
      }
      return productCatalog;
    }
    
    // Populate product dropdown
    async function populateProductDropdown(selectElement) {
      const catalog = await loadProductCatalog();
      if (!catalog) return;
      
      // Clear existing options except the first one
      while (selectElement.options.length > 1) {
        selectElement.remove(1);
      }
      
      // Add each product as an option
      catalog.products.forEach(product => {
        const option = document.createElement('option');
        option.value = product.product_name;
        option.textContent = product.product_name;
        selectElement.appendChild(option);
      });
    }
    
    // Populate variation dropdown based on selected product
    async function populateVariationDropdown(selectElement, productName) {
      const catalog = await loadProductCatalog();
      if (!catalog) return;
      
      // Clear existing options except the first one
      while (selectElement.options.length > 1) {
        selectElement.remove(1);
      }
      
      // Find the selected product
      const product = catalog.products.find(p => p.product_name === productName);
      if (!product) return;
      
      // Add each variation as an option
      product.variations.forEach(variation => {
        const option = document.createElement('option');
        option.value = variation.name;
        option.textContent = variation.name;
        option.dataset.basePrice = variation.base_price;
        selectElement.appendChild(option);
      });
    }
    
    // Update base price based on selected product and variation
    async function updateBasePrice(row) {
      const catalog = await loadProductCatalog();
      if (!catalog) return;
      
      const productSelect = row.querySelector('.entry-product-name');
      const variationSelect = row.querySelector('.entry-variation');
      const priceInput = row.querySelector('.entry-price');
      
      if (!productSelect.value) return;
      
      // Find the selected product
      const product = catalog.products.find(p => p.product_name === productSelect.value);
      if (!product) return;
      
      // Find the selected variation or use the first one
      let basePrice = 0;
      if (variationSelect.value) {
        const variation = product.variations.find(v => v.name === variationSelect.value);
        if (variation) {
          basePrice = variation.base_price;
        }
      } else if (product.variations.length > 0) {
        basePrice = product.variations[0].base_price;
      }
      
      // Store the base price as a data attribute for reference, but don't auto-populate the selling price
      row.dataset.basePrice = basePrice;
      
      // We don't auto-populate selling price from base price since they are different
      // Instead, we just make sure the MP Fee gets updated if the selling price is changed
      updateMpFee(row);
    }
    
    // Update MP Fee calculation
    async function updateMpFee(row) {
      const catalog = await loadProductCatalog();
      if (!catalog) return;
      
      const productSelect = row.querySelector('.entry-product-name');
      const quantityInput = row.querySelector('.entry-quantity');
      const priceInput = row.querySelector('.entry-price');
      const mpFeeInput = row.querySelector('.entry-mpfee');
      
      // If any required field is empty, don't update
      if (!productSelect.value || !quantityInput.value || !priceInput.value) return;
      
      const quantity = parseInt(quantityInput.value) || 0;
      const unitPrice = parseFloat(priceInput.value) || 0;
      const subtotal = quantity * unitPrice;
      
      // Find the product category
      const product = catalog.products.find(p => p.product_name === productSelect.value);
      if (!product) return;
      
      // Calculate estimated MP Fee (this is the same logic as in generate-report.js)
      // Note: We're not loading mpfeerules.json here, so this is just an estimate
      // The server will calculate the actual MP fee using the proper rules
      let estimatedFee = 0;
      
      if (product.category === 'A') {
        // Category A fee estimate (e.g., 5%)
        estimatedFee = subtotal * 0.05;
      } else {
        // Category B fee estimate (e.g., 7%)
        estimatedFee = subtotal * 0.07;
      }
      
      // Round to nearest whole number
      estimatedFee = Math.round(estimatedFee);
      
      // Update the MP Fee input if it's empty or if it's the default value
      if (!mpFeeInput.value || mpFeeInput.value === '0') {
        mpFeeInput.value = estimatedFee;
      }
    }
    
    // Update row color based on selected platform
    function updateRowColorByPlatform(row, platform) {
      // Remove any existing platform classes
      row.classList.remove('platform-tokopedia', 'platform-lazada', 'platform-instore');
      
      // Add the appropriate class based on the selected platform
      if (platform) {
        row.classList.add(`platform-${platform}`);
      }
    }
    
    // Save manual entries
    function saveManualEntries() {
      // Get all filled rows
      const filledRows = Array.from(document.querySelectorAll('.manual-entry-row')).filter(row => {
        // Consider a row filled if at least order number and product name are provided
        const orderNumber = row.querySelector('.entry-order-number').value.trim();
        const productName = row.querySelector('.entry-product-name').value.trim();
        return orderNumber && productName;
      });
      
      if (filledRows.length === 0) {
        showManualEntryResult('Please fill in at least one row with order data.', 'warning');
        return;
      }
      
      // Validate all fields in filled rows
      let isValid = true;
      filledRows.forEach(row => {
        // Remove any previous validation classes
        row.querySelectorAll('input, select').forEach(input => {
          input.classList.remove('invalid-input');
        });
        
        // Check required fields
        const requiredInputs = row.querySelectorAll('input[required], select[required]');
        requiredInputs.forEach(input => {
          if (!input.value.trim()) {
            input.classList.add('invalid-input');
            isValid = false;
          }
        });
        
        // Validate numeric fields
        const numericInputs = [...row.querySelectorAll('.entry-quantity, .entry-price, .entry-mpfee, .entry-voucher')];
        numericInputs.forEach(input => {
          const value = Number(input.value);
          if (isNaN(value) || value < 0) {
            input.classList.add('invalid-input');
            isValid = false;
          }
        });
      });
      
      if (!isValid) {
        showManualEntryResult('Please correct the highlighted fields.', 'danger');
        return;
      }
      
      // Show processing status
      const statusEl = document.getElementById('manual-entry-status');
      statusEl.classList.remove('d-none');
      statusEl.innerHTML = `
        <div class="d-flex align-items-center">
          <div class="spinner-border spinner-border-sm me-2" role="status">
            <span class="visually-hidden">Processing...</span>
          </div>
          <span>Processing your entries. Please wait...</span>
        </div>
        <div class="progress mt-2" style="height: 5px;">
          <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
        </div>
      `;
      
      // Disable the save button
      document.getElementById('save-entries-btn').disabled = true;
      
      // Format entries into expected JSON format for the backend
      const entriesToSave = filledRows.map(row => {
        const orderDate = row.querySelector('.entry-date').value;
        const orderNumber = row.querySelector('.entry-order-number').value.trim();
        const platform = row.querySelector('.entry-platform').value;
        const productName = row.querySelector('.entry-product-name').value.trim();
        const variationName = row.querySelector('.entry-variation').value.trim();
        
        // Parse numeric values explicitly to ensure they're numbers, not strings
        const quantity = parseInt(row.querySelector('.entry-quantity').value) || 1;
        const price = parseFloat(row.querySelector('.entry-price').value) || 0;
        const mpFee = parseFloat(row.querySelector('.entry-mpfee').value) || 0;
        const voucher = parseFloat(row.querySelector('.entry-voucher').value) || 0;
        
        console.log(`Order ${orderNumber} - MP Fee (parsed): ${mpFee}, type: ${typeof mpFee}`);
        
        // Match the format expected by the backend (as in orderData.json)
        return {
          "No. Pesanan": orderNumber,
          "Status Pesanan": "Selesai", // Default to completed
          "Waktu Pembayaran Dilakukan": formatDateForBackend(orderDate),
          "Nama Produk": productName,
          "Nama Variasi": variationName,
          "Harga Setelah Diskon": price,
          "Jumlah": quantity,
          "Voucher Ditanggung Penjual": voucher,
          "Platform": platform,
          "MP Fee Manual": mpFee // This will be used in the generateReport function
        };
      });
      
      // Get import mode
      const isAppendMode = document.getElementById('manualAppendMode').checked;
      
      try {
        // Create a simple JSON string for transmission
        const jsonData = JSON.stringify(entriesToSave);
        
        // Prepare data for submission
        const formData = new FormData();
        formData.append('manualData', jsonData);
        formData.append('appendData', isAppendMode ? 'true' : 'false');
        
        // Log the data being sent (for debugging)
        console.log('Sending manual entry data length:', jsonData.length);
        
        // Create a controller for timeout
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
        
        // Send data to the server
        fetch('/manual-entry', {
          method: 'POST',
          body: formData,
          signal: controller.signal
        })
        .then(response => {
          clearTimeout(timeoutId);
          // Check if the response is OK
          if (!response.ok) {
            return response.text().then(text => {
              console.error('Server response error:', text);
              throw new Error(`Server returned ${response.status}: ${text}`);
            });
          }
          return response.json();
        })
        .then(data => {
          // Hide processing status
          statusEl.classList.add('d-none');
          document.getElementById('save-entries-btn').disabled = false;
          
          if (data.success) {
            // Show success message
            showManualEntryResult(
              `${entriesToSave.length} orders added successfully. ${isAppendMode ? 'Data has been appended.' : 'Data has been replaced.'}`,
              'success'
            );
            
            // Clear the form (for better UX, keep one empty row)
            document.getElementById('manual-entries').innerHTML = '';
            addManualEntryRow();
            
            // Reload the report data
            setTimeout(() => {
              loadReportData();
            }, 1000);
          } else {
            showManualEntryResult(`Error: ${data.error}`, 'danger');
          }
        })
        .catch(error => {
          clearTimeout(timeoutId);
          statusEl.classList.add('d-none');
          document.getElementById('save-entries-btn').disabled = false;
          
          if (error.name === 'AbortError') {
            showManualEntryResult('Request timed out. The server took too long to respond.', 'danger');
          } else {
            showManualEntryResult(`Error: ${error.message}`, 'danger');
          }
          console.error('Fetch error:', error);
        });
      } catch (error) {
        statusEl.classList.add('d-none');
        document.getElementById('save-entries-btn').disabled = false;
        showManualEntryResult(`Error preparing data: ${error.message}`, 'danger');
        console.error('Data preparation error:', error);
      }
    }
    
    // Format date for backend
    function formatDateForBackend(isoString) {
      const date = new Date(isoString);
      // Format: YYYY-MM-DD HH:MM
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      
      return `${year}-${month}-${day} ${hours}:${minutes}`;
    }
    
    // Show manual entry result
    function showManualEntryResult(message, type = 'success') {
      const resultEl = document.getElementById('manual-entry-result');
      resultEl.textContent = message;
      resultEl.className = `alert alert-${type}`;
      resultEl.classList.remove('d-none');
    }
  </script>
</body>
</html>